<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LANCER Job Board - Finances</title>
  <link rel="stylesheet" href="/css/terminal.css">
  <link rel="stylesheet" href="/css/currency.css">
  <link rel="stylesheet" href="/css/client.css">
</head>
<body class="<%= colorScheme %>">
  <div class="terminal-header">
    <div class="terminal-header-left">
      <h1>> <span id="portal-heading"><%= settings.portalHeading %></span> - FINANCES_</h1>
      <p>> USER_GROUP: <span id="user-group"><%= settings.userGroup %></span>_</p>
      <p>> FINANCIAL_STATUS: ACTIVE_</p>
      <a href="/client/overview" class="terminal-link">[OVERVIEW]</a>
    </div>
    <div class="terminal-header-right">
      <p class="terminal-info">> UNT: <span id="unt"><%= settings.unt %></span>U</p>
      <p class="terminal-info">> CURRENT_GALACTIC_POS: <span id="galactic-pos"><%= settings.currentGalacticPos %></span></p>
      <% if (!settings.openTable) { %>
      <div class="operation-progress">
        <div class="operation-progress-label">> OPERATION_PROGRESS:</div>
        <div class="progress-bar-container">
          <div class="progress-segment <%= settings.operationProgress >= 1 ? 'filled' : '' %>" id="progress-segment-1"></div>
          <div class="progress-segment <%= settings.operationProgress >= 2 ? 'filled' : '' %>" id="progress-segment-2"></div>
          <div class="progress-segment <%= settings.operationProgress >= 3 ? 'filled' : '' %>" id="progress-segment-3"></div>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <div class="content">
    <div class="finances-container">
      <div class="balance-overview">
        <h2>> CURRENT_MANNA_BALANCE:</h2>
        <div class="balance-display" id="balance-display">
          <%= totalBalance %>
          <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
        </div>
      </div>

      <div class="transactions-history">
        <h2>> TRANSACTION_HISTORY:</h2>
        <div id="transactions-container">
          <% if (allTransactions.length > 0) { %>
            <div class="transactions-table" id="transactions-table">
              <% allTransactions.forEach(transaction => { %>
                <div class="transaction-row">
                  <div class="transaction-date">
                    <%= new Date(transaction.date).toLocaleString('en-GB', { 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit', 
                      hour: '2-digit', 
                      minute: '2-digit' 
                    }) %>
                  </div>
                  <div class="transaction-amount <%= transaction.totalAmount >= 0 ? 'positive' : 'negative' %>">
                    <%= transaction.totalAmount >= 0 ? '+' : '' %><%= transaction.totalAmount %>
                    <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
                  </div>
                  <div class="transaction-description"><%= transaction.description %></div>
                  <div class="transaction-pilots">
                    Pilots: 
                    <%= transaction.relatedPilotCallsigns && transaction.relatedPilotCallsigns.length > 0
                          ? transaction.relatedPilotCallsigns.join(', ')
                          : 'None' %>
                  </div>
                  <div class="transaction-balance">
                    Balance: <%= transaction.cumulativeBalance %>
                    <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <p id="no-transactions">> NO_TRANSACTIONS_RECORDED_</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/shared-handlers.js"></script>
  <script src="/js/sse-client.js"></script>
  <script>
    // Handle manna and pilot updates from SSE
    function handleMannaUpdate(data) {
      if (data && data.balances && data.balances.activeBalance !== undefined) {
        // Update balance display
        const balanceDisplay = document.getElementById('balance-display');
        if (balanceDisplay) {
          balanceDisplay.innerHTML = `
            ${data.balances.activeBalance}
            <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
          `;
        }
      }
      
      // For transaction-related changes, reload to ensure full consistency
      if (data && (data.action === 'transaction' || data.action === 'update' || data.action === 'delete')) {
        // TODO: Consider dynamically updating transaction list instead of reload
        // For now, a full page reload ensures consistency
        window.location.reload();
      }
    }
    
    function handlePilotsUpdate(data) {
      // Pilot changes affect transaction history display
      // Only reload if this would impact the displayed data
      if (data && data.pilots) {
        window.location.reload();
      }
    }
  </script>
</body>
</html>
